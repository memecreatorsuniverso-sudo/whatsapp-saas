const { default: makeWASocket, useMultiFileAuthState, DisconnectReason } = require("@whiskeysockets/baileys")
const QRCode = require("qrcode")

async function startBot() {
    const { state, saveCreds } = await useMultiFileAuthState("./auth")

    const sock = makeWASocket({
        auth: state,
    })

    sock.ev.on('connection.update', (update) => {
        const { connection, lastDisconnect, qr } = update
        if (qr) {
            QRCode.toString(qr, { type: 'terminal' }, (err, url) => {
                if (err) return console.error('Failed to generate QR:', err)
                console.log(url)
            })
        }

        if (connection === 'open') {
            console.log('âœ… Connected to WhatsApp')
        }

        if (connection === 'close') {
            const reason = lastDisconnect && lastDisconnect.error && lastDisconnect.error.output ? lastDisconnect.error.output : lastDisconnect
            console.log('Connection closed:', reason)
        }
    })

    sock.ev.on('creds.update', saveCreds)
}

startBot().catch(err => {
    console.error('Bot failed:', err)
    process.exit(1)
})
